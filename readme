###
#   Creator      | Evonne McArthur
#   Created      | 2020-05-08
#   Last Updated | 2021-06-03
###

Data & Code for paper:
Quantifying the contribution of Neanderthal introgression to the heritability of complex traits - McArthur, Rinker, Capra
https://www.biorxiv.org/content/10.1101/2020.06.08.140087v1

''' ./bin/nean_h2_paper.ipynb ''' : Analysis code and all figure generating code in a Jupyter notebook
  # To run, see the list/build of packages used in the environment (env.txt), the main packages needed
    include numpy, pandas, matplotlib, scipy, statsmodel, pybedtools
  # To install, make sure the packages are available in your environment and download the code/data! (< 5 min)
  # This has been tested in the given conda environment (on a linux and windows OS,  no non-standard hardware needed)
  # Applications of each section of the code have examples using real data used in the nean_h2_paper, example output and graphs are also present
  # Expected runtime for the whole notebook is a few hours but running it piecemeal for whatever section you need is recommended (a few cells take an hour+ and those are noted)
  # You can plug your own data into any of the analyses as long as they are in your working directory

  # Table of Contents:
    1. Import packages
    2. Input: Partitioned heritability files
    3. Input: Neanderthal introgressed regions
    4. Fig 1. Heritability analysis from LDSC for 41 traits
    5. Fig 2. Heritability analysis from LDSC for 400+ UKBB traits
    6. Fig 3. Direction of effect analysis
    7. Fig 4. Interesting examples
    8. Other supplemental results
    9. Discussion analysis

''' ./bin/nean_h2_paper.html''' : Html version of the above Jupyter notebook

''' ./bin/env.txt '''
  Generated by conda list > env.txt
  List and build of packages used in the environment to run the above Jupyter noteboook

''' ./bin/hg19.genome ''': Hg19 genome file for pybedtools

''' ./data/partitioned_h2/ ''': Partitioned heritability results from S-LDSC
  # [UKBB_]introgressed[SNPs/Regions]_[enrichment/pval/stderr].tsv
    Tab separated values from LDSC partitioned heritability analysis
    If UKBB is in the name, it is for all 405 traits from the UKBB and FinnGen (Fig2), if not it is for the 41 traits (Fig1)
    Each column is using a different set of Neanderthal variants (see below for input files):
    Set #1 (more stringent): ALLEUR_NMATCH_sprime_results.bed
    Set #2: ALL1KG_NMATCH_sprime_results.bed
    Set #3: ALLEUR_sprime_results.bed
    Set #4: (least stringent) ALL1KG_sprime_results.bed
  
  # [vernot/vindija]_[enrichment/pval/stderr].tsv
    Tab sep values from LDSC partitioned h2 analysis. The "vernot" files are for introgressed haplotypes and variants identified using the S* statistic from Vernot et al. 2016. The "vindija" files are hapltoypes and variants identified using Sprime from Browning et al. with the Vindija genome (instead of the Altai)
    For both, the first column are the haplotype-level analyses (subpanel A in the supplemental figures) and the introgresed snp-level analyses are in the second column (subpanel B)

  # mafMatchedRandomSnps_rawPvalsFigS5.tsv
    Empirically generated partitioned heritability p-values (maf-matched to set #1 above) used for Fig S5

  # mafStratifiedh2Enr_rawFigS8.tsv
    Partitioned heritability raw enrichment results for Fig S8 (Altaimatching introgressed variants stratified by MAF) 

''' ./sumstat_domains_finalplusImmunoSubchapters.txt '''
  # Larger version of Table S2
  To make conclusions on a domain level, we categorize traits by their phenotypic “domains,” “chapters,” and “subchapters”.
  We derive these designations from the GWAS Atlas, a database of publicly available GWAS summary statistics.(Watanabe et al., 2019)
  The GWAS Atlas had categorized many of the 405 UK Biobank traits; however, because GWAS Atlas uses different criteria for inclusion
  into their database, some of these traits were uncategorized. For the uncategorized UK Biobank traits and the other set of 41 traits,
  we manually assigned them into existing domains, chapters, subchapters based on similar categorized traits. The only edit to the existing
  designations was changing subchapter labels of the immunologic domain. All its subchapter instances (N=14) were labeled
  “Immunological System Functions.” We manually changed this generic label to either “RBC” or “WBC.” For example, reticulocyte
  count and mean corpuscular hemoglobin fall under RBC, while eosinophil count and neutrophil fall under WBC. The 405 GWAS cross 21 domains,
  31 chapters, and 62 subchapters. However, we note that this organization is not purely hierarchical (e.g. some traits in the same subchapter belong in two different domains).

''' ./data/otherSupplemental/geneticCorrLogs/[Trait_Trait].log ''': Pairwise genetic correlation for Sunburn, SkinColor & Tanning from LDSC

''' ./data/otherSupplemental/backgroundWindows.bed ''': Bed file for the 'background genome' considered by analysis in Fig. S9. These are used to develop an empirical distribution for expected overlap between genomic windows identified by SLDP and adaptive haplotypes (from Chen et al. 2020 and Gittelman et al. 2016). 

''' ./data/input_neanderthal_regions/ ''': input regions generated from Sprime results from Browning18, used in LDSC & SLDP analyses
  # [CEU, TSI, FIN, GBR, ISB]_sprime_segments_neanMatchingFilter.bed:
    All segments for each population matching a filter that gives us some confidence that these regions are introgressed from neanderthals. The filters are that there must be at least 30 alleles that could be compared with neanderthal (nmatch + nmismatch) >= 30. And that the proportion of alleles that could be compared matches neanderthal >= 30% of the time nmatch/(nmatch + nmismatch) >=.3
    The columns are chr, start, stop, number of alleles that match the neanderthal allele in that segment, number of alleles that don't match neanderthal, and number of alleles that you can't compare (likely due to quality issues)
  # ALLEUR_sprime_segments_neanMatchingFilter.bed
    All European segments combined (union) and sorted. It's a combination of files that had the above 30+ snps and 30% match filter applied to them before combining. Created by:
    for i in CEU FIN GBR IBS TSI; do cat "$i"_sprime_segments_neanMatchingFilter.bed >> ALLEUR_sprime_segments_neanMatchingFilter.bed; done;
    sort -k1,1 -k2,2n ALLEUR_sprime_segments_neanMatchingFilter.bed > tmp; mv tmp ALLEUR_sprime_segments_neanMatchingFilter.bed
    bedtools merge -i ALLEUR_sprime_segments_neanMatchingFilter.bed > tmp; mv tmp ALLEUR_sprime_segments_neanMatchingFilter.bed
  # ALL1KG_sprime_results.bed (Set #4)
    All SNPs with evidence of introgression from Browning18, Created by:
    for i in *_sprime_results.tar.gz; do echo "$i"; tar xvzf "$i"; ls ./mendeley_data/* | wc -l; for j in ./mendeley_data/*; do tail -n+2 "$j" >> ALL1KG_sprime_results.txt; done; rm -r ./mendeley_data/; done
    cut -f 1,2,3,4,5,7,9,10 ALL1KG_sprime_results.txt | sort -u > tmp; mv tmp ALL1KG_sprime_results.txt
    for i in *.txt; do cat "$i" | awk '{print "chr"$1"\t"$2-1"\t"$2"\t"$3"\t"$4"\t"$5"\t"$6"\t"$7"\t"$8}' | sort -k1,1 -k2,2n > "$i".bed; done
  # ALL1KG_NMATCH_sprime_results.bed (Set #2)
    All SNPs with evidence of introgression & matching the neanderthal allele from Browning18, Created by:
    cat ALL1KG_sprime_results.txt | awk '$7 == "match" {print $0}' > ALL1KG_NMATCH_sprime_results.txt
    for i in *.txt; do cat "$i" | awk '{print "chr"$1"\t"$2-1"\t"$2"\t"$3"\t"$4"\t"$5"\t"$6"\t"$7"\t"$8}' | sort -k1,1 -k2,2n > "$i".bed; done
    # ALLEUR_sprime_results.bed (Set #3)
    All SNPs with evidence of introgression found in the European populations from Browning18, Created by:
    for i in CEU FIN GBR IBS TSI; do echo "$i"_sprime_results.tar.gz; tar xvzf "$i"_sprime_results.tar.gz; ls ./mendeley_data/ | wc -l; for j in ./mendeley_data/*; do tail -n+2 "$j" >> EUR_sprime_results.txt; done; rm -r ./mendeley_data/; done
    cut -f 1,2,3,4,5,7,9,10 EUR_sprime_results.txt | sort -u > tmp; mv tmp EUR_sprime_results.txt
    for i in *.txt; do cat "$i" | awk '{print "chr"$1"\t"$2-1"\t"$2"\t"$3"\t"$4"\t"$5"\t"$6"\t"$7"\t"$8}' | sort -k1,1 -k2,2n > "$i".bed; done
  # ALLEUR_NMATCH_sprime_results.bed (Set #1)
    All SNPs with evidence of introgression found in the European populations & matching neanderthal allele from Browning18, Created by:
    cat ALLEUR_sprime_results.txt | awk '$7 == "match" {print $0}' > EUR_NMATCH_sprime_results.txt
    for i in *.txt; do cat "$i" | awk '{print "chr"$1"\t"$2-1"\t"$2"\t"$3"\t"$4"\t"$5"\t"$6"\t"$7"\t"$8}' | sort -k1,1 -k2,2n > "$i".bed; done
  # SNPs_in_ALLEUR_sprime_segments_neanMatchingFilter.bed
    SNPs in the ALLEUR sprime segments. The SNPs are all intersections with 1000G.EUR.allChr.bed (All SNPs from 1000G bim file /LDSC/data/1000G_EUR_Phase3_plink/1000G.EUR.QC.*.bim concatenated together. Turned into a bed file by chr pos-1 pos). The snps are intersected with the neanderthal segments matching filter (30 SNPs and 30%+ neanderthal match).
    bedtools intersect -wb -a 1000G.EUR.allChr.bed -b ALLEUR_sprime_segments_neanMatchingFilter.bed > SNPs_in_ALLEUR_sprime_segments_neanMatchingFilter.bed
    sort -k 1,1 -k2,2n SNPs_in_ALLEUR_sprime_segments_neanMatchingFilter.bed > tmp; mv tmp SNPs_in_ALLEUR_sprime_segments_neanMatchingFilter.bed
  # ALL1KG_sprime_results_r2\=.5.bed
    The ALL1KG_sprime_results.bed SNPs LD expanded to r2 >= 0.5 using David&Ling's LD2bedpartners script (using European population from 1000G). Example of command used to generate:
    (bed2LDpartners) [mcarthe@capra1 data]$ /dors/capra_lab/users/rinkerd/bin/bed2LDpartners.py EUR 1 ALLEUR_sprime_results.bed > ALLEUR_sprime_results_r2=1.bed &
  # SNPs_in_ALLEUR_sprime_segments_neanMatchingFilter_MINUS_ALL1KG_sprime_results_r2=.5.bed
    SNPs in the ALLEUR sprime segments. The SNPs are all intersections with 1000G.EUR.allChr.bed. The snps are intersected with the neanderthal segments matching filter (30 SNPs and 30%+ neanderthal match). Putatively introgressed SNPs and their LD r2 >= 0.5 partners are subtracted from these regions
    bedtools subtract -a SNPs_in_ALLEUR_sprime_segments.bed -b ALL1KG_sprime_results_r2\=.5.bed >  SNPs_in_ALLEUR_sprime_segments_MINUS_ALL1KG_sprime_results_r2=.5.bed
    sort -k 1,1 -k2,2n SNPs_in_ALLEUR_sprime_segments_MINUS_ALL1KG_sprime_results_r2\=.5.bed > tmp; mv tmp SNPs_in_ALLEUR_sprime_segments_MINUS_ALL1KG_sprime_results_r2\=.5.bed

''' ./data/input_neanderthal_regions/SLDP_input/ '''
  Input formatted for signed LD profile regression, see ipynb for generating scripts

''' ./data/SLDP_results/ ''' Output from the directional analysis using Signed LD profile regression
  # [trait].gwresults: 
    raw output from SLDP quantifying the correlation between the Neanderthal LD profile and the marginal trait association
  # aggregate.results
    results from all the [trait].gwresults into one file
  # [trait]snpsfile.tsv.7z
    the per-snp information from SLDP. For each variant, it provides information on the trait-association and the Neanderthal LD profile. The files are windowed across to find regions with high correlation between Neanderthal LD profile and marginal trait association ("interestingWindows"). Note these files are 7zipped
  # interestingWindows/
    raw output of windows with a high correlation between Neanderthal LD profile and marginal trait association. These are windows with a correlation coefficient > 0.5 and at least one variant marginally associated with the trait (P < 1e-4). Later processing steps merge these windows and identify windows that overlap with at least one Altai-matching Neanderthal introgressed allele (set #1 see above). With those further processing steps, we generated Table S8.


